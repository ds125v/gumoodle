<?php // $Id: email.html,v 2.02 2008/08/18 17:09:43 whchuang Exp $

/**
 * email.html - Prints the email form for Quickmail
 *
 * @Original author Mark Nielsen, updated by Bibek Bhattarai and Wen Hao Chuang
 * @version $Id: email.html,v 2.01 2007/04/05 09:33:43 wenhaochuang Exp $
 * @package quickmailv2 (enhanced quickmail for large classes)
 **/
 
/**
 * Updated features:
 *	- Replaces checkbox with selection list for effective usability in case of larger classes
 *  - Added external email client feature
 *  - Added a help button to explain external email client
 *  - Removed group mode functionality
 *  - Removed email log on the server side. We allow users to use external email client so that they could keep a record
 *  - but we do not want all these logs exhaust our precious server space as we have many quickmail users
 **/ 

?>
<!-- link to javascript in selection.js -->
<script language="JavaScript" src="selection.js"></script>
<!-- calls function java script createListObjects every time theform is loaded -->

<!-- Call java script function createListObject every time the form is re-loaded !-->
<body onLoad="createListObjects()">
<form name="theform" method="post" action="email.php" enctype="multipart/form-data">
<table border="0" cellpadding="5">
<tr>
  <td>&nbsp;</td>
  <td colspan="3" align="right"><!--<a href="emaillog.php?id=<?php echo $course->id . '&amp;instanceid='. $instance->id ?>"><?php print_string('emailhistory', 'block_quickmail'); ?></a>!--></td>
</tr>
<tr>
  <td align="right"><b>From:</b></td>
  <td align="left"><?php echo $USER->email; ?></td>
  <td>&nbsp;</td>
  <td>&nbsp;</td>
</tr>
<tr>
    <td width="200">&nbsp;</td>
    <td align="right" width="200">
      <div align="left"><strong><?php print_string('to', 'block_quickmail'); ?></strong></div></td>
    <td align="right">&nbsp;</td>
    <td align="right" width="200"><div align="right"><strong><?php print_string('potentialreceipent', 'block_quickmail'); ?></strong></div></td>
</tr>
<tr valign="top">
    <td align="right"><div align="center"></div></td>
    <td width="200">
        <div align="left">
          <!-- Populate mailto list from $mail_list that stored list of users to be emailed variable -->
		  <select name="mail_to" size="20" multiple id="mail_to">
			<?php
				foreach($mail_list as $id) { 
          			$id = stripslashes($id);
					$id = str_replace("\"","",$id);
					if($id != ""){
						echo '<option value="'.$id.' '.$courseusers[$id]->email.'">'.$courseusers[$id]->firstname.' '.$courseusers[$id]->lastname.' {'.$courseusers[$id]->email.'}</option>';
					}
          		}				
       		?>
		</select>
        </div></td>
    <?php check_theme_arrows(); ?>
    <td width="75">
		<div align="center" margin-top="10px">
            <br />
                <input type = "button" id="add" onClick="add_user()" style="width:110px; height:35px" 
                       value="<?php echo $THEME->larrow.'&nbsp;'.get_string('add'); ?>"
                       title="Add selected user to selected recipients list"/>
            <br />
                <input type = "button" id="remove" onClick="remove_user()" style="width:110px; height:35px"
                       value="<?php echo get_string('remove').'&nbsp;'.$THEME->rarrow; ?>" 
                       title="Remove selected users from selected recipients list"/>
            <br />
            <br />
                <input type = "button" id="addall" onClick="addAll()" style="width:110px; height:35px" 
                       value="<?php echo $THEME->larrow.$THEME->larrow.'&nbsp;'.get_string('addall'); ?>"
                       title="Add all users from selected recipients list"/>
          	<br />
                <input type = "button" id="removeall" onClick="removeAll()" style="width:110px; height:35px"
                       value="<?php echo get_string('removeall').'&nbsp;'.$THEME->rarrow.$THEME->rarrow; ?>" 
                       title="Remove all users from selected recipients list"/>
		</div></td>
    <td width="200"><div align="right">
      <!-- Populate members list from $courseusers that stores list of users in the course -->		  
	  <select name="members" size="20" multiple id="members">
      <?php 
		foreach($courseusers as $user) { 
			$show = true;
			//if the id already exists in mail_list id then do not display
			foreach($mail_list as $id){
				$id = stripslashes($id);
				$id = str_replace("\"","",$id);
				if($id == $user->id){
					$show = false;
				}						
			}
			if($show){
	        		echo '<option value="'.$user->id.' '.$user->email.'">'.fullname($user, true).' {'.$user->email.'}</option>';
			}
       	}			
      ?>          
	  </select>
    </div></td>
</tr>
<tr valign="top">
  <td align="right"></td>
  <td colspan="3">
  	<input type = "button" id="mailto" onClick="mail_to_ext_client()" value="Use external email client to send this message"/>
  <?php
      helpbutton('extemail', get_string('helpextemail'), 'moodle', true, true);
      echo '<br />';
  ?>
  </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php print_string('subject', 'forum'); ?>:</b></td>
    <td colspan="3">
        <input type="text" name="subject" size="80" value="<?php echo $form->subject; ?>" />
    </td>
</tr>
<tr valign="top">
    <td align="right"><b>
     <?php print_string('message', 'forum'); ?>:</b></td>
    <td colspan="3" rowspan="2" align="left">
    <?php print_textarea($usehtmleditor, 25, 65, 630, 400, 'message', $form->message); ?>
    </td>
</tr>
<tr valign="top">
    <td align="right" valign="center" nowrap="nowrap">
        <font size="2">
            <?php
                helpbutton('reading', get_string('helpreading'), 'moodle', true, true);
                echo '<br />';
                helpbutton('writing', get_string('helpwriting'), 'moodle', true, true);
                echo '<br />';
                if ($usehtmleditor) {
                   helpbutton('richtext', get_string('helprichtext'), 'moodle', true, true);
                } else {
                   emoticonhelpbutton('theform', 'message');
                } 
            ?>
        </font>
    </td>
</tr>

<!-- Hiding format choice option from users as it is not applicable for us -->
<!--<tr valign="top">
    <td align="right"><b><?php print_string('formattexttype'); ?>:</b></td>
    <td colspan="3">
    <?php 
        if ($usehtmleditor) {   /// Trying this out for a while
            print_string('formathtml');
            echo '<input type="hidden" name="format" value="'.FORMAT_HTML.'" />';
        } else {
            choose_from_menu(format_text_menu(), 'format', $form->format, '');
        }
        helpbutton('textformat', get_string('helpformatting'));
     ?>
    </td>
</tr>-->
<?php 
 	echo '<input type="hidden" name="format" value="'.FORMAT_HTML.'" />';
?>

<tr valign="top">
    <td align="right" nowrap="nowrap">
        <b><?php print_string('attachmentoptional', 'block_quickmail'); ?>:</b>
    </td>
    <td colspan="3">
    <?php
        if (has_capability('moodle/course:managefiles', $context)) {
            echo '<input type="text" name="attachment" size="90" value="'.$form->attachment.'" alt="'.get_string('attachmentalt', 'block_quickmail').'" /><br />';
            button_to_popup_window ("/files/index.php?id=$course->id&choose=theform.attachment", "coursefiles", $strchooseafile, 500, 750, $strchooseafile);
        } else {
            $maxbytes = get_max_upload_file_size($CFG->maxbytes, $course->maxbytes);
            echo '<input type="hidden" name="MAX_FILE_SIZE" value="'.$maxbytes.'" />';
            echo '<input type="file" name="attachment" size="45" alt="'.get_string('attachmentalt', 'block_quickmail').'" /> ';
            print_string('maxsize', '', display_size($maxbytes));
        }
    ?>
    </td>
</tr>

<tr>
    <td align="center" colspan="4">
	<input type="hidden" name="mailuser" id="mailuser" value=""/>
    <input type="hidden" name="sesskey" value="<?php echo $USER->sesskey; ?>" />
	<input type= "hidden" name="fromemail" value="<?php echo $USER->email; ?>" id="fromemail" />	
    <input type="hidden" name="id" value="<?php echo $course->id; ?>" />
    <input type="hidden" name="instanceid" value="<?php echo $instance->id; ?>" />
    <input type="submit" name="cancel" value="<?php print_string('cancel') ?>" />
    <input type="submit" name="sendemail" value="<?php print_string('sendemail', 'block_quickmail') ?>" onClick = "updateList()"/>
    </td>
</tr>
</table>
</form>
</body>
